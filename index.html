<!doctype html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Shoutbox</title>
  </head>
  <body>
    <h2>Shoutbox</h2>
    <div id="messages"></div>
    <form>        
      <input type="text" id="name" placeholder="Name"><br>
      <textarea id="message" rows="5" cols="80" placeholder="Message"></textarea>
      <a href="" onclick="return sendMessage()">Send</a>
    </form>

    <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-firestore.js"></script>
    <script>
      var config = {
        apiKey: "AIzaSyDvAa0JAemTE7qtm4X7okfr2D2HxwHuy5c",
        authDomain: "shoutbox-test.firebaseapp.com",
        projectId: "shoutbox-test"  
      };
      firebase.initializeApp(config);

      var db = firebase.firestore();

      
      function sendMessage() {
        db.collection("messages").add({
          name: document.getElementById("name").value,
          message: document.getElementById("message").value,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("name").value = "";
        document.getElementById("message").value = "";
        return false;
      }

      function getTimeString(time) {
        var minutePart = time.getMinutes() < 10 ? "0"+time.getMinutes() : time.getMinutes();
        return time.getDate()+"."+(time.getMonth()+1)+". "+time.getHours()+":"+minutePart;
      }

      var messagesDiv = document.getElementById('messages');
      
      db.collection("messages").orderBy('time')
        .onSnapshot(function(snapshot) {     
          snapshot.docChanges.forEach(function(change) {
            if (change.type === "added") {
              console.log(change.doc.id, " => ", change.doc.data());
              var newDiv = document.createElement("div");
              newDiv.className = "message";
              var time = change.doc.data().time == null ? new Date(Date.now()) : change.doc.data().time;
              
              newDiv.innerHTML = `
                <span class="name">${change.doc.data().name}</span> <span class="time">${getTimeString(time)}</span>
                <p class="text">${change.doc.data().message}</p>`;
              messagesDiv.appendChild(newDiv);
            }
          });    
      });
    </script>
  </body>
</html>
