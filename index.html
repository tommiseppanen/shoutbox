<!doctype html>
<html>
  <head>
      <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Shoutbox</title>
  </head>
  <body>
    <div class="wrap">
      <h2>Shoutbox</h2>
      <div id="messages"></div>
      <form>
        <div class="form-row">
          <label for="name">Name:</label><br/>
          <input type="text" id="name" placeholder=""><br/>
        </div>
        <div class="form-row">
           <label for="message">Message:</label><br/>
          <textarea id="message" rows="5" cols="80"></textarea>
        </div>        
        <a href="" onclick="return sendMessage()">Send</a>
      </form>
    </div>
    

    <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase-firestore.js"></script>
    <script>
      var config = {
        apiKey: "AIzaSyDvAa0JAemTE7qtm4X7okfr2D2HxwHuy5c",
        authDomain: "shoutbox-test.firebaseapp.com",
        projectId: "shoutbox-test"  
      };
      firebase.initializeApp(config);

      var db = firebase.firestore();

      
      function sendMessage() {
        db.collection("messages").add({
          name: document.getElementById("name").value,
          message: document.getElementById("message").value,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("name").value = "";
        document.getElementById("message").value = "";
        return false;
      }

      function getTimeString(time) {
        var minutePart = time.getMinutes() < 10 ? "0"+time.getMinutes() : time.getMinutes();
        return time.getDate()+"."+(time.getMonth()+1)+". "+time.getHours()+":"+minutePart;
      }

      var messagesDiv = document.getElementById('messages');
      
      db.collection("messages").orderBy('time')
        .onSnapshot(function(snapshot) {     
          snapshot.docChanges.forEach(function(change) {
            if (change.type === "added") {
              console.log(change.doc.id, " => ", change.doc.data());
              var newDiv = document.createElement("div");
              newDiv.className = "message";
              var time = change.doc.data().time == null ? new Date(Date.now()) : change.doc.data().time;
              
              newDiv.innerHTML = `
                <span class="name">${change.doc.data().name}</span> <span class="time">${getTimeString(time)}</span>
                <p class="text">${change.doc.data().message}</p>`;
              messagesDiv.appendChild(newDiv);
            }
          });    
      });
    </script>
  </body>
</html>
